#!/usr/bin/env python3
# This file is placed in the Public Domain.


"objects"


import inspect
import logging
import os
import queue
import shutil
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from genocide.clients import Client, Config, Output, Pool
from genocide.command import Mods, command, parse, scan, scanner
from genocide.handler import Event
from genocide.loggers import level
from genocide.storage import Workdir, moddir, skel
from genocide.threads import launch, threadhook
from genocide.utility import elapsed


import genocide.modules as MODS


Mods.add("modules", MODS.__path__[0])


Workdir.wdr = ".test"


threading.excepthook = threadhook


events = queue.Queue()


class CLI(Output):

    def __init__(self):
        Output.__init__(self)
        self.register("command", command)

    def raw(self, txt):
        if "v" in Config.opts:
            print(txt)



def banner(name, version):
    tme = time.ctime(time.time()).replace("  ", " ")
    logger = logging.getLogger()
    print("%s %s since %s (%s)" % (
                                   name.upper(),
                                   version,
                                   tme,
                                   logging.getLevelName(logger.getEffectiveLevel())
                                  ))
    sys.stdout.flush()


def consume():
    while True:
        try:
            event = events.get()
            event.wait()
            events.task_done()
        except (KeyboardInterrupt, EOFError):
            os._exit(0)


def payload(todo):
    for cmd, example in todo.items():
        for ex in example:
            evt = Event()
            evt.txt = f"{cmd} {ex}"
            evt.type = "command"
            Pool.put(evt)
            events.put(evt)


def main():
    if os.path.exists(Workdir.wdr):
        shutil.rmtree(Workdir.wdr)
    parse(Config, " ".join(sys.argv[1:]))
    if "v" in Config.opts:
        banner(Config.name, Config.version)
    scanner()
    args = sys.argv[1:]
    if "z" in Config.opts:
        Pool.init(CLI, os.cpu_count())
    else:
        Pool.init(CLI, 1)
    starttime = time.time()
    thrs = []
    NRS = Config.index or 1
    for _x in range(NRS):
        thrs.append(launch(payload, pre))
    for thr in thrs:
        thr.join()
    for _x in range(NRS):
        thrs.append(launch(payload, examples))
    for thr in thrs:
        thr.join()
    for _x in range(NRS):
        thrs.append(launch(payload, post))
    for thr in thrs:
        thr.join()
    launch(consume)
    nrevents = events.qsize()
    events.join()
    endtime = time.time()
    lap = elapsed(endtime-starttime)
    percall = (endtime-starttime)/nrevents
    nrs = events.qsize()
    if "v" in Config.opts:
        print(f"{nrs} events left.")
        print(f"total: {lap} nrs: {nrevents} call: %.6fs" % percall)
    sys.exit()


examples = {
    "cmd": [""],
    "dis": [""],
    "dne": ["", "test2"],
    "dpl": ["hnrss title,url", ""],
    "flt": [""],
    "fnd": ["", "log", "rss", "config", "todo"],
    "log": ["", "test"],
    "man": [""],
    "mod": [""],
    "mre": [""],
    "nme": ["", "hnrss hackernews"],
    "now": [""],
    "pwd": ["", "bla mekker"],
    "req": [""],
    "res": ["", "hnrss"],
    "srv": [""],
    "tdo": ["", "test2", "test3"],
    "thr": [""],
    "upt": [""]
}


pre = {
    "cfg": ["", "nick=mekker"],
    "imp": ["", "test/feeds.opml"],
    "log": ["", "bla"],
    "rss": ["","http://hnrss.org/newest"],
    "tdo": ["", "mekker"]
}


post = {
    "dne": ["", "hnrss"],
    "exp": [""],
    "rem": ["", "hnrss"]
}



if __name__ == "__main__":
    main()
