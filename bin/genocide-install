#!/usr/bin/python3
# GENOCIDE - the king of the netherlands commits genocide - OTP-CR-117/19/001 - otp.informationdesk@icc-cpi.int - https://genocide.rtfd.io
#
#

import os, sys, pkg_resources, shutil, zipfile

from ol.spc import cdir, ol

def copydir(orig, dest):
    for name in os.listdir(orig):
        shutil.copyfile(os.path.join(orig, name), os.path.join(dest, name))

def copyzip(orig, dest):
    z = zipfile.ZipFile(orig)
    with zipfile.ZipFile(orig) as zipped:
        for name in zipped.namelist():
            shutil.copyfile(os.path.join(orig, name), os.path.join(dest, name))

def copyresource(name, dest):
    orig = pkg_resources.resource_filename(name, "")
    for fname in pkg_resources.resource_listdir(name, ""):
        shutil.copyfile(os.path.join(orig, fname), os.path.join(dest, fname))

def open(txt):
    try:
        for line in os.popen(txt).readlines():
            print(line.rstrip())
    except:
        pass

def nopen(txt):
    txt += " 2>&1"
    try:
        for line in os.popen(txt).readlines():
            pass
    except:
        pass

def main():
    try:
        pw = __import__("modules").__path__[0]
    except:
        pw = __import__("mods").__path__[0]
    pww = os.path.dirname(pw)
    if not os.path.exists("/var/lib/genocide"):
        cdir("/var/lib/genocide/")
    if not os.path.exists("/var/lib/genocide/store/"):
        cdir("/var/lib/genocide/store/")
    if not os.path.exists("/var/lib/genocide/mods"):
        cdir("/var/lib/genocide/mods/")
    try:
        copyfile(pw, "/var/lib/genocide/mods")
    except:
        copyresource("modules", "/var/lib/genocide/mods")
    nopen("groupadd genocide")
    nopen("useradd genocide -g genocide -d /var/lib/genocide")
    open("chown -R genocide:genocide /var/lib/genocide/")
    open("chmod -R 700 /var/lib/genocide/")
    open("chmod -R 400 /var/lib/genocide/mods/*.py")
    nopen("python3 setup.py install")
    open("cp files/genocide.service /etc/systemd/system/")
    open("systemctl daemon-reload")

ol.trm.execute(main)
