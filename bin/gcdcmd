#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide

"""GENOCIDE(1)                      User Commands                       GENOCIDE(1)

NAME
        gcd - the king of the netherlands commits genocide  (OTP-CR-117/19)

SYNOPSIS
        gcd <cmd> [mods=mod1,mod2] [-b] [-c] [-h] [-r] [-v] 

OPTIONS
        -b		show banner
        -c 		start console
        -h		print this message
        -r		use /var/lib/ob
        -v		be verbose

EXAMPLES
        genocide cmd
        genocide mod
        genocide mods=irc,rss
        genocidectl krn mods=irc,rss
"""

# imports

import os, sys ; sys.path.insert(0, os.getcwd())

import ob
import readline
import time

from ob.krn import k, op
from gcd.tbl import tbl
from gcd.ver import __version__

# defines

k.cfg.name = "genocide"
k.cfg.pkgs = "ob,mod,gcd"
k.cfg.wd = ob.e("~/.genocide")
k.cfg.version = __version__

# commands

def xit(event):
    ob.bus.Bus.save()
    os._exit(0)

def hup(event):
    ob.dbs.last(k.cfg)
    ob.bus.Bus.resume()

# runtime

def main():
    s = ob.shl.Shell(tbl)
    ob.shl.parse()
    if op("v"):
        k.cfg.verbose = True
    if op("h"):
        print(__doc__)
        return
    if op("b"):
        print("GENOCIDE #%s started at %s" % (k.cfg.version, time.ctime(time.time())))
        print(ob.format(k.cfg, skip=["old", "opts", "res"]))
        print("OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide")
    if op("r"):
        ob.wd = "/var/lib/genocide/"
        ob.utl.privileges("genocide")
        k.cfg.mods += ",irc"
    s.load_mod("krn,req,sui,trt,wsd")
    s.load_mod(k.cfg.sets.mods)
    s.scandir(ob.j(ob.wd, "mod"))
    if k.cfg.res.txt:
        s.load_mod("all")
        return s.cmd(k.cfg.old.txt)
    s.start()
    if op("c"):
        s.add("hup", hup)
        s.add("xit", xit)
        c = ob.shl.Console(tbl)
        c.handler = s
        c.start()        
    elif op("t"):
        Bus.resume()
    s.init(k.cfg.sets.mods)
    if op("ctr"):
        s.wait()

ob.shl.exec(main)
