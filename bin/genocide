#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot"


import inspect
import os
import readline
import sys
import termios


from op.obj import Cfg, Class, Object, get, register
from op.hdl import Bus, Callbacks, Command, Event, Handler
from op.run import Commands, CLI, Console, Table, parse_cli


from genocide import fnd, irc, log, mdl, rss, slg, sts, tdo


Cfg.workdir = os.path.expanduser("~/.genocide")


Table.add(fnd)
Table.add(irc)
Table.add(log)
Table.add(mdl)
Table.add(rss)
Table.add(slg)
Table.add(sts)
Table.add(tdo)


class CLI(CLI):

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


class Console(Console):

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


def wrap(func):
    fd = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fd)
    except termios.error:
        gotterm = False
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fd, termios.TCSADRAIN, old)
        for b in Bus.objs:
            if "errors" in b:
                for err in b.errors:
                    print(err)

def cmd(event):
    event.reply(",".join(sorted(Commands.cmd)))


def main():
    Table.scan()
    Commands.add(cmd)
    txt = " ".join(sys.argv[1:])
    cfg = parse_cli(txt)
    if cfg.cmd:
        c = CLI()
        return c.cmd(txt)
    Table.exec("init")
    c = Console()
    c.start()
    c.forever()


wrap(main)
