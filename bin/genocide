#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide

"""GENOCIDE(1)                      User Commands                       GENOCIDE(1)

NAME
        genocide - the king of the netherlands commits genocide  (OTP-CR-117/19)

SYNOPSIS
        genocide <cmd> [mods=mod1,mod2] [-b] [-c|d] [-h] [-l|s] [-v] 

OPTIONS
        -b		show banner
        -c 		start console
        -d		start daemon
        -h		print this message
        -l		load cfg
        -r		use /var/lib/ob
        -s 		save cfg
        -v		be verbose

EXAMPLES
        genocide cmd
        genocide mod
        genocide mods=irc,rss
        genocidectl krn mods=irc,rss
"""

# imports

import os, sys ; sys.path.insert(0, os.getcwd())
import ob
import readline
import time

from ob import cfg, e, j, save, values, update
from ob.dbs import last
from ob.ofn import format, overlay
from ob.hdl import Bus, Bused, Command, Handler
from ob.shl import Cfg, Console, Shell, op, parse, setcompleter
from ob.thr import launch
from ob.trm import termreset, termsave
from ob.utl import privileges

from gcd.tbl import tbl
from gcd.ver import __version__

# defines

s = Shell(tbl)

cfg.name = "genocide"
cfg.debug = False
cfg.pkgs = "ob,mod,gcd"
cfg.wd = e("~/.genocide")
cfg.version = __version__

# functions

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def exec(main):
    termsave()
    try:
        main()
    except KeyboardInterrupt:
        print("")
    except PermissionError as ex:
        print(str(ex))
    finally:
        termreset()

# commands

def xit(event):
    Bus.save()
    os._exit(0)

def hup(event):
    last(cfg)
    Bus.resume()

# runtime

def main():
    wait = False
    parse()
    if op("v"):
        cfg.verbose = True
    if op("h"):
        print(__doc__)
        return
    if op("r"):
        cfg.wd = "/var/lib/genocide/"
    if op("s"):
        c = Cfg()
        update(c, cfg)
        save(c)
    if op("l"):
        c = Cfg()
        last(c)
        overlay(c, cfg)
        update(cfg, c)
    s.load_mod(cfg.sets.mods)
    s.scandir(j(cfg.wd, "mod"))
    if cfg.res.txt:
        return s.cmd(cfg.old.txt)
    elif op("d"):
        privileges("genocide")
        daemon()
        wait = True
    elif op("c"):
        c = Console(tbl)
        c.handler = s
        c.start()        
        wait = True
    if op("b"):
        print("GENOCIDE #%s started at %s" % (cfg.version, time.ctime(time.time())))
        print(format(cfg, skip=["old", "opts", "res"]))
        print("OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide")
    if op("t"):
        Bus.resume()
    s.start()
    s.init(cfg.sets.mods)
    if wait:
        s.wait()

exec(main)
