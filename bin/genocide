#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os, readline, shutil, sys

from op.bsc import Basic
from op.dbs import last
from op.obj import Object, format, load, register, save, update
from op.prs import parse
from op.run import console, cfg, parse_cli
from op.thr import launch
from op.utl import privileges

cfg.wd = os.path.expanduser("~/.genocide")
cfg.md = os.path.join(cfg.wd, "mod")
wd = "/var/lib/genocide/"
md = "/var/lib/genocide/mod/"

def docfg(event):
    from opbot.irc import Cfg
    c = Cfg()
    last(c)
    if event.prs and not event.prs.sets:
        return event.reply(format(c, skip=["username", "realname"]))
    update(c, event.prs.sets)
    save(c)
    event.reply("ok")

def main():
    parse_cli()
    if cfg.op("h"):
        return print(__doc__)
    if cfg.op("r"):
        cfg.wd = wd
        cfg.md = md
        privileges("genocide")
    if cfg.op("s"):
        save(cfg)
    if cfg.op("l"):
        last(cfg)
    h = Basic()
    h.pkgs = ["opmod", "opbot", "gcd"]
    h.fromdir(cfg.md)
    h.walk("opbot,opmod,gcd")
    if cfg.txt:
        h.add("cfg", docfg)
        return h.cmd(cfg.otxt)
    if cfg.op("c"):
        cfg.mods += ",csl"
    if cfg.op("i"):
        cfg.mods += ",irc"
    h.start()
    h.init(cfg.mods)
    if cfg.op("cw"):
        h.wait()

console(main)
