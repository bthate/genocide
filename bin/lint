#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# pylint: disable=C0114,C0115,C0116,W0703,R1732,C0103,W0621,W1514,C0201,C0209


import json
import os
import subprocess
import sys


os.environ["PATH"] += ":bin"
os.environ["PYTHONPATH"] = os.getcwd()
os.environ["PYTHONUNBUFFERED"] = "1"


SKIP = [
        "***",
        "---",
        "Your code",
        "bin/genocide"
       ]


SKIPDIR = [
           "docs",
           "files",
           "env",
           ".git",
           "README.rst",
           "MANUAL.rst",
           'tsd'
          ]


def doskip(txt, skiplist):
    if not txt.strip():
        return True
    for skp in skiplist:
        if skp in txt:
            return True
    return False


def diff(obj, obj2):
    result = {}
    for key, value in obj2.items():
        if key in obj and obj[key] != value:
            result[key] = value
    return result


def dump(path, result):
    old = os.getcwd()
    os.chdir(path)
    for fnn in os.listdir(path):
        if doskip(fnn, SKIPDIR):
            continue
        older = os.getcwd()
        fpath = os.path.abspath(os.path.join(path, fnn))
        if os.path.isdir(fpath):
            dump(fpath, result)
            continue
        if not os.path.isdir(fpath):
            mtime = os.path.getmtime(path)
            result[fpath] = mtime
        os.chdir(older)
    os.chdir(old)


def loop(path, txt):
    old = os.getcwd()
    os.chdir(path)
    for fnn in os.listdir(path):
        if fnn in SKIPDIR:
            continue
        if fnn.startswith("."):
            continue
        #if not os.path.exists("%s/__init__.py" % fnn):
        #    continue
        old = os.getcwd()
        fpath = os.path.abspath(os.path.join(path, fnn))
        if os.path.isdir(fpath):
            loop(fpath, txt)
        if not os.path.isdir(fpath):
            continue
        os.chdir(fpath)
        for fnm in os.listdir(fpath):
            popen(txt + " " + fnm)
            print(f"{fpath}/{fnm}")
            sys.stdout.flush()
        os.chdir(old)
    os.chdir(old)


def popen(txt):
    for line in os.popen(txt).readlines():
        if doskip(line, SKIP):
            continue
        print(line.rstrip())
        sys.stdout.flush()



def popen2(txt):
    proc = subprocess.Popen(
                            txt.split(),
                            stdin=sys.stdin,
                            stdout=sys.stdout,
                            stderr=sys.stderr,
                            close_fds=False,
                            text=True
                           )
    proc.communicate()
    proc.wait()


if __name__ == "__main__":
    popen("clean")
    result = {}
    old = {}
    if os.path.exists("tsd"):
        try:
            with open("tsd") as tsd:
                old.update(json.load(tsd))
        except json.decoder.JSONDecodeError:
            pass
    dump(os.getcwd(), result)
    tsd = open("tsd", "w")
    json.dump(result, tsd)
    tsd.flush()
    tsd.close()
    dif = diff(old, result)
    nr = 0
    for fn in dif.keys():
        print(fn)
        popen("pylint %s " % fn)
        nr += 1
    if not nr:
        print("no changes")
    #loop(os.getcwd(), "pylint")
