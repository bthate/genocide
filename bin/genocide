#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot"


import inspect
import os
import sys
import termios


from op.obj import Cfg, Class, Object, get, register
from op.hdl import Bus, Callbacks, Command, Event, Handler


from genocide import fnd, irc, log, mdl, rss, slg, sts, tdo


Cfg.workdir = os.path.expanduser("~/.genocide")


class Table():

    mod = {}

    @staticmethod
    def add(obj):
        Table.mod[obj.__name__] = obj

    @staticmethod
    def exec(cmd):
        for mod in Table.mod.values():
            func = getattr(mod, cmd, None)
            if func:
                func()

    @staticmethod
    def get(name):
        return Table.mod.get(name, None)

    @staticmethod
    def scan(mns=None):
        for mod in Table.mod.values():
            if mns and mod.__name__ not in mns:
                continue
            for _k, obj in inspect.getmembers(mod, inspect.isfunction):
                if "event" in obj.__code__.co_varnames:
                    Commands.add(obj)
            for _k, clz in inspect.getmembers(mod, inspect.isclass):
                Class.add(clz)


class Commands(Object):

    cmd = Object()

    @staticmethod
    def add(cmd):
        register(Commands.cmd, cmd.__name__, cmd)

    @staticmethod
    def get(cmd):
        return get(Commands.cmd, cmd)


    @staticmethod
    def remove(cmd):
        del Commands.cmd[cmd]


class CLI(Handler):

    def announce(self, txt):
        self.raw(txt)

    def cmd(self, txt):
        cmd = Command()
        cmd.channel = ""
        cmd.orig = repr(self)
        cmd.txt = txt
        self.handle(cmd)
        cmd.wait()

    def raw(self, txt):
        print(txt)


class Console(CLI):

    def handle(self, e):
        Handler.handle(e)
        e.wait()

    def poll(self):
        e = Command()
        e.channel = ""
        e.cmd = ""
        e.txt = input("> ")
        e.orig = repr(self)
        if e.txt:
            e.cmd = e.txt.split()[0]
        return e


def dispatch(event):
    event.parse()
    func = Commands.get(event.cmd)
    if func:
        func(event)
        event.show()
    event.ready()


def parse_cli(txt):
    event = Event()
    event.parse(txt)
    return event


Callbacks.add("command", dispatch)


Table.add(fnd)
Table.add(irc)
Table.add(log)
Table.add(mdl)
Table.add(rss)
Table.add(slg)
Table.add(sts)
Table.add(tdo)


class CLI(CLI):

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


class Console(Console):

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


def wrap(func):
    fd = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fd)
    except termios.error:
        gotterm = False
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fd, termios.TCSADRAIN, old)
        for b in Bus.objs:
            if "errors" in b:
                for err in b.errors:
                    print(err)

def cmd(event):
    event.reply(",".join(sorted(Commands.cmd)))


def main():
    Table.scan()
    Commands.add(cmd)
    txt = " ".join(sys.argv[1:])
    cfg = parse_cli(txt)
    if cfg.cmd:
        c = CLI()
        return c.cmd(txt)
    Table.exec("init")
    c = Console()
    c.start()
    c.forever()


wrap(main)
