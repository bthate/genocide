#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C,I,R,W,E0402


__author__ = "B.H.J. Thate <thatebhj@gmail.com>"
__version__ = 1


import os
import sys
import traceback


sys.path.insert(0, os.getcwd())


import genocide.modules


from genocide.clients import Client
from genocide.command import command
from genocide.errored import Errors
from genocide.message import parse
from genocide.persist import Persist
from genocide.scanner import scanpkg, importer


Persist.workdir = "/var/lib/genocide/"


class CLI(Client):

    def announce(self, txt):
        pass

    @staticmethod
    def raw(txt):
        print(txt)
        sys.stdout.flush()


def waiter():
    got = []
    for ex in Error.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Error.errors.remove(exc)


def main():
    cfg = parse(' '.join(sys.argv[1:]))
    scanpkg(genocide.modules, importer, doall=True)
    cli = CLI()
    command(cli, cfg.otxt)
    waiter()


main()
