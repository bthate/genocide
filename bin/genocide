#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide

"""GENOCIDE(1)                      User Commands                       GENOCIDE(1)

NAME
        genocide - the king of the netherlands commits genocide (OTP-CR-117/19)

SYNOPSIS
        genocide <cmd> [mods=mod1,mod2] [-b] [-c] [-d] [-h] [-l] [-s] [-v] 
        genocide cmd
        genocide mod
        genocide mods=shl,irc,rss

OPTIONS
        -b		show banner
        -d		start daemon
        -h		print this message
        -l		load cfg
        -r		use /var/lib/ob
        -s 		save cfg
        -v		be verbose
"""

# imports

import os, sys ; sys.path.insert(0, os.getcwd())
import ob
import readline
import time

from ob import Cfg, cfg, e, j, oupdate, save
from ob.dbs import last
from ob.ofn import format
from ob.hdl import Bus, Bused, Command, Console, Handler
from ob.shl import Shell, op, parse, setcompleter
from ob.thr import launch
from ob.trm import termreset, termsave
from ob.utl import privileges

from gcd.tbl import tbl
from gcd.ver import __version__

# functions

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def exec(main):
    termsave()
    try:
        main()
    except KeyboardInterrupt:
        print("")
    except PermissionError as ex:
        print(str(ex))
    finally:
        termreset()

# commands

def xit(event):
    Bus.save()
    os._exit(0)

def hup(event):
    last(cfg)
    Bus.resume()

# runtime

def main():
    parse()
    if not cfg.sets.mods:
        cfg.sets.mods ="all"
    if op("h"):
        print(__doc__)
        return
    if op("s"):
        save(cfg)
    if op("l"):
        c = Cfg()
        last(c)
        oupdate(cfg, c)
    if op("r"):
        cfg.wd = "/var/lib/genocide/"
        cfg.md = j(cfg.wd, "mod")
    if op("b"):
        print("GENOCIDE is placed in the Public Domain. No COPYRiGHT. No LICENSE.")
        print("started at %s (#%s)" % (time.ctime(time.time()), cfg.version))
        print(format(cfg, skip=["old", "opts", "res", "sets"]))
    s.load_mod(cfg.sets.mods)
    s.scandir(cfg.md)
    if cfg.res.txt:
        return s.cmd(cfg.old.txt)
    if op("d"):
        privileges("ob")
        daemon()
    if op("t"):
        Bus.resume()
    s.start()
    bots = s.init(cfg.sets.mods)
    for bot in bots:
        bot.wait()

# runtime

s = Shell(tbl)

cfg.debug = False
cfg.pkgs = "ob,mod,gcd"
cfg.wd = e("~/.genocide")
cfg.md = j(os.getcwd(), "mod")
cfg.version = __version__

exec(main)
