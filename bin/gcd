#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
# OTP-CR-117/19 otp.informationdesk@icc-cpi.int http://pypi.org/project/genocide

"""GENOCIDE(1)                      User Commands                       GENOCIDE(1)

NAME
        gcd - the king of the netherlands commits genocide  (OTP-CR-117/19)

SYNOPSIS
        gcd <cmd> [mods=mod1,mod2] [-b] [-c] [-h] [-r] [-v] 

OPTIONS
        -b		show banner
        -c 		start console
        -h		print this message
        -r		use /var/lib/ob
        -v		be verbose

EXAMPLES
        gcd cmd
        gcd mod
        gcd mods=irc,rss
        gcd krn mods=irc,rss
"""

# imports

import os, sys ; sys.path.insert(0, os.getcwd())

import ob
import readline
import time

from ob.krn import Bus, Shell, cfg, exec, last, op, parse
from gcd.tbl import tbl
from gcd.ver import __version__

# commands

def xit(event):
    Bus.save()
    os._exit(0)

def hup(event):
    ob.dbs.last(k)
    Bus.resume()

# runtime

def main():
    parse("genocide")
    if op("v"):
        cfg.verbose = True
    if op("h"):
        print(__doc__)
        return
    if op("b"):
        print("%s #%s started at %s" % (cfg.name, cfg.version, time.ctime(time.time())))
        print(ob.format(cfg, skip=["old", "res"]))
    s = Shell(tbl)
    s.load_mod("krn")
    s.scandir(ob.j(ob.wd, "mod"))
    if op("r"):
        ob.wd = "/var/lib/%s/" % cfg.name.lower()
        ob.utl.privileges(cfg.name.lower())
        cfg.mods += ",irc"
    if cfg.old.txt:
        return s.cmd(cfg.old.txt)
    if op("c"):
        s.add("hup", hup)
        s.add("xit", xit)
        c = ob.shl.Console(tbl)
        c.handler = s
        c.start()
    elif op("t"):
        Bus.resume()
    s.init(cfg.mods)
    s.start()
    if op("ctr"):
        s.wait()

exec(main)
