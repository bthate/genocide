#!/usr/bin/env python3
# This file is placed in the Public Domain.


"Prosecutor. Court. Reconsider OTP-CR-117/19."


__version__ = "74"


import os
import readline
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())
sys.path.insert(0, "lib")


from obj import Config


Config.name = "genocide"
Config.threaded = False
Config.version = __version__
Config.workdir = os.path.expanduser("~/.genocide")


from genocide.irc import Config as IConfig


IConfig.realname = "Prosecutor. Court. Reconsider OTP-CR-117/19."


from obe import Event
from obj import Class, Db, Object
from obj import cdir, find, fntime, format, get, items, save, spl, update
from obh import Callbacks, Commands, Handler, Table
from obh import getname, starttime
from obr import Console, CLI, boot, init, isopt


from genocide import basic, irc, model, rss, slg


Table.add(basic)
Table.add(irc)
Table.add(model)
Table.add(rss)
Table.add(slg)


class CLI(CLI):

    def raw(self, txt):
        print(txt)


class Console(Console):

    def announce(self, txt):
        pass

    def raw(self, txt):
        print(txt)


def wrap(func):
    fd = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fd)
    except termios.error:
        gotterm = False
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main():
    boot(" ".join(sys.argv[1:]), "genocide", "basic,irc,model,rss,slg")
    cdir(Config.workdir)
    if len(sys.argv) > 1:
        c = CLI()
        return c.cmd(" ".join(sys.argv[1:]))
    print("%s shell started at %s" % (Config.name.upper(), time.ctime(starttime).replace("  ", " ")))
    init("irc,model,rss", "genocide")
    print(format(Config, skip="password,type"))
    c = Console()
    c.start()
    c.forever()


wrap(main)
