#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot"


import inspect
import os
import readline
import sys
import termios


from genocide.obj import Wd, Class, Object, get, register
from genocide.hdl import Bus, Callbacks, Command, Event, Handler
from genocide.hdl import Cfg, Commands, Client, parse, scan


Cfg.name = "genocide"


from genocide import bsc, fnd, irc, log, mdl, rss, slg, sts, tdo


Wd.workdir = os.path.expanduser("~/.genocide")


scan(bsc)
scan(fnd)
scan(irc)
scan(log)
scan(mdl)
scan(rss)
scan(slg)
scan(sts)
scan(tdo)


class Console(Client):

    def handle(self, event):
        Client.handle(event)
        event.wait()

    def poll(self):
        event = Command()
        event.channel = ""
        event.cmd = ""
        event.txt = input("> ")
        event.orig = repr(self)
        if event.txt:
            event.cmd = event.txt.split()[0]
        return event

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


def wrap(func):
    fd = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fd)
    except termios.error:
        gotterm = False
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fd, termios.TCSADRAIN, old)
        for b in Bus.objs:
            if "errors" in b:
                for err in b.errors:
                    print(err)


def main():
    parse(" ".join(sys.argv[1:]))
    irc.init()
    rss.init()
    mdl.init()
    c = Console()
    c.start()
    c.forever()


wrap(main)
